window.Wikia=window.Wikia||{},window.Wikia.adServices=function(t){var e={};function n(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:r})},n.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=5)}([function(t,e){t.exports=window.Wikia.adEngine},function(t,e){function n(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}t.exports=function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}},function(t,e){t.exports=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}},function(t,e,n){var r=n(8),i=n(7),o=n(6);t.exports=function(t){return r(t)||i(t)||o()}},function(t,e,n){var r=n(11),i=n(10),o=n(9);t.exports=function(t,e){return r(t)||i(t,e)||o()}},function(t,e,n){"use strict";n.r(e);var r=n(4),i=n.n(r),o=n(3),a=n.n(o),c=n(2),s=n.n(c),u=n(1),l=n.n(u),d=n(0),g=function(){function t(){s()(this,t),this.methods={}}return l()(t,[{key:"register",value:function(t,e){d.utils.logger("executor","method ".concat(t," registered")),this.methods[t]=e}},{key:"execute",value:function(t,e,n){var r=this.methods[t];if("function"!=typeof r)throw Error("".concat(t," is not executable"));d.utils.logger("executor","executing ".concat(t," method"),e.name,n),r(e,n)}},{key:"executeMethods",value:function(t,e){var n=this;Object.keys(e).forEach(function(r){var i=e[r].result,o=t.find(function(t){return t.name===r&&t.executable});if(o){var a=o["on_".concat(i)];a&&a.forEach(function(t){return n.execute(t,o,i)})}})}}]),t}(),f=function(){function t(){s()(this,t),this.projects={}}return l()(t,[{key:"enable",value:function(t){d.utils.logger("project-handler","project ".concat(t," enabled")),this.projects[t]=!0}},{key:"isEnabled",value:function(t){return!!this.projects[t]}},{key:"getEnabledModelsWithParams",value:function(t){var e=this,n=d.context.get("services.billTheLizard.projects"),r=d.context.get("services.billTheLizard.parameters"),i=[],o={};return Object.keys(n).filter(function(n){return e.isEnabled(n)&&t.includes(n)}).forEach(function(t){var e=!0;n[t].forEach(function(n){d.utils.isProperGeo(n.countries,n.name)?(n.executable=e,e=!1,i.push(n),Object.assign(o,r[t])):n.executable=!1})}),{models:i,parameters:o}}}]),t}(),v="bill-the-lizard",p=[];function h(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4?arguments[4]:void 0,o=new window.XMLHttpRequest,a=function(t){var e=[];return Object.keys(t).forEach(function(n){e.push("".concat(n,"=").concat(t[n]))}),encodeURI(e.join("&"))}(n),c=function(t,e,n){return"".concat(t,"/").concat(e,"?").concat(n)}(t,e,a);return d.events.emit(d.events.BILL_THE_LIZARD_REQUEST,{query:a,callId:i}),o.open("GET",c,!0),o.responseType="json",o.timeout=r,p.push(o),d.utils.logger(v,"timeout configured to",o.timeout),new Promise(function(t,e){o.addEventListener("timeout",function(){e(new Error("timeout")),d.utils.logger(v,"timed out")}),o.addEventListener("error",function(){e(new Error("error")),d.utils.logger(v,"errored")}),o.onreadystatechange=function(){4===this.readyState&&200===this.status&&(d.utils.logger(v,"has response"),t(this.response))},o.send()})}d.events.registerEvent("BILL_THE_LIZARD_REQUEST"),d.events.registerEvent("BILL_THE_LIZARD_RESPONSE");var m=function(){function t(){s()(this,t),this.executor=new g,this.projectsHandler=new f,this.targetedModelNames=new Set,this.callCounter=0,this.predictions=[],this.statuses={}}return l()(t,[{key:"reset",value:function(){this.callCounter=0,this.predictions=[],this.statuses={},p.forEach(function(t){return t.abort()}),p=[],d.context.remove("targeting.btl")}},{key:"call",value:function(e,n){var r=this;if(!d.context.get("services.billTheLizard.enabled"))return d.utils.logger(v,"disabled"),new Promise(function(t,e){return e(new Error("Disabled"))});n||(this.callCounter+=1,n=this.callCounter);var i=d.context.get("services.billTheLizard.host"),o=d.context.get("services.billTheLizard.endpoint"),c=d.context.get("services.billTheLizard.timeout"),s=this.projectsHandler.getEnabledModelsWithParams(e),u=s.models,l=s.parameters;if(!u||u.length<1)return d.utils.logger(v,"no models to predict"),this.statuses[n]=t.NOT_USED,Promise.resolve({});u.filter(function(t){return t.dfp_targeting}).forEach(function(t){return r.targetedModelNames.add(t.name)});var g=function(t,e){var n=new Date,r=n.getDay()-1;return Object.assign({},{models:t.map(function(t){return t.name}),h:n.getHours(),dow:-1===r?6:r},e)}(u,l);return d.utils.logger(v,"calling service",i,o,g,"callId: ".concat(n)),this.statuses[n]=t.TOO_LATE,h(i,o,g,c,n).catch(function(e){return"timeout"===e.message?r.statuses[n]=t.TIMEOUT:r.statuses[n]=t.FAILURE,Promise.reject(e)}).then(function(t){return function(t){return Object.keys(t).forEach(function(e){var n=d.utils.queryString.get("bill.".concat(e));n&&(t[e].result=parseInt(n,10))}),t}(t)}).then(function(e){var i;d.utils.logger(v,"service response OK","callId: ".concat(n)),r.statuses[n]=t.ON_TIME;var o=r.getModelToResultMap(e);d.utils.logger(v,"predictions",o,"callId: ".concat(n));var c=r.buildPredictions(u,o,n);return(i=r.predictions).push.apply(i,a()(c)),r.setTargeting(),d.events.emit(d.events.BILL_THE_LIZARD_RESPONSE,{callId:n,response:r.serialize(n)}),r.executor.executeMethods(u,e),o}).catch(function(t){return d.utils.logger(v,"service response",t.message,"callId: ".concat(n)),{}})}},{key:"buildPredictions",value:function(t,e,n){return t.map(function(t){return t.name}).filter(function(t){return void 0!==e[t]}).map(function(t){return{modelName:t,callId:n,result:e[t]}})}},{key:"getModelToResultMap",value:function(t){var e={};return Object.keys(t).forEach(function(n){var r=t[n].result;void 0!==r&&(e[n]=r)}),e}},{key:"setTargeting",value:function(){var t=this.getTargeting();if(Object.keys(t).length>0){var e=Object.entries(t).map(function(t){var e=i()(t,2),n=e[0],r=e[1];return"".concat(n,"_").concat(r)});return d.context.set("targeting.btl",e),e}return""}},{key:"getTargeting",value:function(){var t=this,e={};return this.predictions.filter(function(e){return t.targetedModelNames.has(e.modelName)}).forEach(function(t){e[t.modelName]=t.result}),e}},{key:"getPrediction",value:function(t,e){return this.getPredictions(t).find(function(t){return t.callId===e})}},{key:"getPredictions",value:function(t){return t?this.predictions.filter(function(e){return e.modelName.split(":")[0]===t.split(":")[0]}):this.predictions}},{key:"getResponseStatus",value:function(t){return t=t||this.callCounter,this.statuses[t]}},{key:"serialize",value:function(t){var e=this.predictions;return void 0!==t&&(e=e.filter(function(e){return e.callId===t})),e.map(function(t){return"".concat(t.modelName,"|").concat(t.callId,"=").concat(t.result)}).join(",")}},{key:"getPreviousPrediction",value:function(e,n,r){if(!(e<=1))for(var i=e-1;i>=1;i--){var o=n(i),a=this.getResponseStatus(o);if(a===t.ON_TIME||a===t.TOO_LATE)return this.getPrediction(r,o)}}}]),t}();m.FAILURE="failure",m.NOT_USED="not_used",m.ON_TIME="on_time",m.TIMEOUT="timeout",m.TOO_LATE="too_late",m.REUSED="reused";var x=new m,y="clarium.global.ssl.fastly.net";var w=new(function(){function t(){s()(this,t)}return l()(t,[{key:"call",value:function(){var t=d.context.get("services.confiant.propertyId"),e=d.context.get("services.confiant.mapping"),n=d.context.get("services.confiant.activation");return d.context.get("services.confiant.enabled")&&t&&e&&n?(d.utils.logger("confiant","loading"),window._clrm=window._clrm||{},window._clrm.gpt={propertyId:t,confiantCdn:y,sandbox:0,mapping:e,activation:n,callback:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];d.utils.logger("confiant",e)}},function(){var t="//".concat(y,"/gpt/a/wrap.js");return d.utils.scriptLoader.loadScript(t,"text/javascript",!0,"first")}().then(function(){d.utils.logger("confiant","ready")})):(d.utils.logger("confiant","disabled"),Promise.resolve())}}]),t}()),b="d3b02estmut877";var E=new(function(){function t(){s()(this,t)}return l()(t,[{key:"call",value:function(){var t=d.context.get("services.geoEdge.id"),e=d.context.get("services.geoEdge.config");return d.context.get("services.geoEdge.enabled")&&t?(d.utils.logger("geo-edge","loading"),window.grumi={cfg:e,key:t},function(){var t="//".concat(b,".cloudfront.net/grumi-ip.js");return d.utils.scriptLoader.loadScript(t,"text/javascript",!0,"first")}().then(function(){d.utils.logger("geo-edge","ready")})):(d.utils.logger("geo-edge","disabled"),Promise.resolve())}}]),t}());function k(t){if(window.localStorage)return window.localStorage[t];if(window.navigator.cookieEnabled){var e=document.cookie.match("".concat(t,"=([^;]*)"));return e&&decodeURI(e[1])||""}return""}window.Krux=window.Krux||function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];window.Krux.q.push(e)},window.Krux.q=window.Krux.q||[];var _=new(function(){function t(){s()(this,t)}return l()(t,[{key:"call",value:function(){var t=this;return d.context.get("services.krux.enabled")&&d.context.get("options.trackingOptIn")?(d.utils.logger("krux","loading"),function(){var t=d.context.get("services.krux.id"),e="//cdn.krxd.net/controltag?confid=".concat(t);return d.utils.scriptLoader.loadScript(e,"text/javascript",!0,"first",{id:"krux-control-tag"})}().then(function(){t.exportPageParams(),t.importUserData()})):(d.utils.logger("krux","disabled"),Promise.resolve())}},{key:"exportPageParams",value:function(){Object.keys(d.context.get("targeting")).forEach(function(t){var e=d.context.get("targeting.".concat(t));e&&(window["kruxDartParam_".concat(t)]=e)})}},{key:"importUserData",value:function(){var t=k("kxuser")||k("kxwikia_user"),e=k("kxsegs")||k("kxwikia_segs");d.context.set("targeting.kuid",t||null),d.context.set("targeting.ksg",e?e.split(","):[]),d.utils.logger("krux","data set",t,e)}},{key:"getUserId",value:function(){return d.context.get("targeting.kuid")||null}},{key:"getSegments",value:function(){return d.context.get("targeting.ksg")||[]}}]),t}());d.events.registerEvent("MOAT_YI_READY");var T=new(function(){function t(){s()(this,t)}return l()(t,[{key:"call",value:function(){var t,e=this;if(!d.context.get("services.moatYi.enabled")||!d.context.get("services.moatYi.partnerCode"))return d.utils.logger("moat-yi","disabled"),Promise.resolve();var n=new Promise(function(e){t=e});return d.utils.logger("moat-yi","loading"),window.moatYieldReady=function(){e.importPageParams(),t()},d.context.set("targeting.m_data","waiting"),function(){var t=d.context.get("services.moatYi.partnerCode"),e="//z.moatads.com/".concat(t,"/yi.js");return d.utils.scriptLoader.loadScript(e,"text/javascript",!0,"first")}().then(function(){d.utils.logger("moat-yi","ready")}),n}},{key:"importPageParams",value:function(){if(window.moatPrebidApi&&"function"==typeof window.moatPrebidApi.getMoatTargetingForPage){var t=window.moatPrebidApi.getMoatTargetingForPage()||{};d.context.set("targeting.m_data",t.m_data),d.events.emit(d.events.MOAT_YI_READY,"m_data=".concat(t.m_data)),d.utils.logger("moat-yi","moatYieldReady",t)}}}]),t}());var I="nielsen-dcr",P={};function O(t){return d.utils.logger(I,"loading"),function(t,e){t[e]=t[e]||{nlsQ:function(n,r,i,o,a,c){return(o=(a=t.document).createElement("script")).async=1,o.src=("http:"===t.location.protocol?"http:":"https:")+"//cdn-gl.imrworldwide.com/conf/"+n+".js#name="+r+"&ns="+e,(c=a.getElementsByTagName("script")[0]).parentNode.insertBefore(o,c),t[e][r]=t[e][r]||{g:i||{},ggPM:function(n,i,o,a,c){(t[e][r].q=t[e][r].q||[]).push([n,i,o,a,c])}},t[e][r]}}}(window,"NOLBUNDLE"),NOLBUNDLE.nlsQ(t,"nlsnInstance",P)}var j=new(function(){function t(){s()(this,t),this.nlsnInstance=null,"1"===d.utils.queryString.get("nielsen-dcr-debug")&&(P.nol_sdkDebug="debug")}return l()(t,[{key:"call",value:function(t){var e=d.context.get("services.nielsen.appId");return d.context.get("services.nielsen.enabled")&&e?(this.nlsnInstance||(this.nlsnInstance=O(e)),d.utils.logger(I,"ready"),this.nlsnInstance.ggPM("staticstart",t),d.utils.logger(I,"called",t),this.nlsnInstance):(d.utils.logger(I,"disabled"),null)}}]),t}());n.d(e,"BillTheLizard",function(){return m}),n.d(e,"billTheLizard",function(){return x}),n.d(e,"confiant",function(){return w}),n.d(e,"geoEdge",function(){return E}),n.d(e,"krux",function(){return _}),n.d(e,"moatYi",function(){return T}),n.d(e,"nielsen",function(){return j})},function(t,e){t.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}},function(t,e){t.exports=function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}},function(t,e){t.exports=function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}},function(t,e){t.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}},function(t,e){t.exports=function(t,e){var n=[],r=!0,i=!1,o=void 0;try{for(var a,c=t[Symbol.iterator]();!(r=(a=c.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{r||null==c.return||c.return()}finally{if(i)throw o}}return n}},function(t,e){t.exports=function(t){if(Array.isArray(t))return t}}]);
//# sourceMappingURL=ad-services.global.js.map