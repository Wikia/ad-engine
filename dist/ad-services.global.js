window.Wikia=window.Wikia||{},window.Wikia.adServices=function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=6)}([function(e,t){e.exports=window.Wikia.adEngine},function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}e.exports=function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}},function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}},function(e,t,n){var r=n(9),i=n(8),o=n(7);e.exports=function(e){return r(e)||i(e)||o()}},function(e,t,n){var r=n(12),i=n(11),o=n(10);e.exports=function(e,t){return r(e)||i(e,t)||o()}},function(e,t,n){"use strict";n.r(t);var r=n(5),i=n.n(r),o=n(4),a=n.n(o),c=n(2),s=n.n(c),u=n(1),l=n.n(u),d=n(3),g=n.n(d),f=n(0),v=function(){function e(){s()(this,e),this.methods={}}return l()(e,[{key:"register",value:function(e,t){f.utils.logger("executor","method ".concat(e," registered")),this.methods[e]=t}},{key:"execute",value:function(e,t,n){var r=this.methods[e];if("function"!=typeof r)throw Error("".concat(e," is not executable"));f.utils.logger("executor","executing ".concat(e," method"),t.name,n),r(t,n)}},{key:"executeMethods",value:function(e,t){var n=this;Object.keys(t).forEach(function(r){var i=t[r].result,o=e.find(function(e){return e.name===r&&e.executable});if(o){var a=o["on_".concat(i)];a&&a.forEach(function(e){return n.execute(e,o,i)})}})}}]),e}(),p=function(){function e(){s()(this,e),this.projects={}}return l()(e,[{key:"enable",value:function(e){f.utils.logger("project-handler","project ".concat(e," enabled")),this.projects[e]=!0}},{key:"isEnabled",value:function(e){return!!this.projects[e]}},{key:"getEnabledModelsWithParams",value:function(e){var t=this,n=f.context.get("services.billTheLizard.projects"),r=f.context.get("services.billTheLizard.parameters"),i=[],o={};return Object.keys(n).filter(function(n){return t.isEnabled(n)&&e.includes(n)}).forEach(function(e){var t=!0;n[e].forEach(function(n){f.utils.isProperGeo(n.countries,n.name)?(n.executable=t,t=!1,i.push(n),Object.assign(o,r[e])):n.executable=!1})}),{models:i,parameters:o}}}]),e}(),h="bill-the-lizard",m=[];function x(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4?arguments[4]:void 0,o=new window.XMLHttpRequest,a=function(e){var t=[];return Object.keys(e).forEach(function(n){t.push("".concat(n,"=").concat(e[n]))}),encodeURI(t.join("&"))}(n),c=function(e,t,n){return"".concat(e,"/").concat(t,"?").concat(n)}(e,t,a);return f.events.emit(f.events.BILL_THE_LIZARD_REQUEST,{query:a,callId:i}),o.open("GET",c,!0),o.responseType="json",o.timeout=r,m.push(o),f.utils.logger(h,"timeout configured to",o.timeout),new Promise(function(e,t){o.addEventListener("timeout",function(){t(new Error("timeout")),f.utils.logger(h,"timed out")}),o.addEventListener("error",function(){t(new Error("error")),f.utils.logger(h,"errored")}),o.onreadystatechange=function(){4===this.readyState&&200===this.status&&(f.utils.logger(h,"has response"),e(this.response))},o.send()})}f.events.registerEvent("BILL_THE_LIZARD_REQUEST"),f.events.registerEvent("BILL_THE_LIZARD_RESPONSE");var y=function(){function e(){s()(this,e),this.executor=new v,this.projectsHandler=new p,this.targetedModelNames=new Set,this.callCounter=0,this.predictions=[],this.statuses={}}return l()(e,[{key:"reset",value:function(){this.callCounter=0,this.predictions=[],this.statuses={},m.forEach(function(e){return e.abort()}),m=[],f.context.remove("targeting.btl")}},{key:"call",value:function(t,n){var r=this;if(!f.context.get("services.billTheLizard.enabled"))return f.utils.logger(h,"disabled"),new Promise(function(e,t){return t(new Error("Disabled"))});n||(this.callCounter+=1,n=this.callCounter);var i=f.context.get("services.billTheLizard.host"),o=f.context.get("services.billTheLizard.endpoint"),c=f.context.get("services.billTheLizard.timeout"),s=this.projectsHandler.getEnabledModelsWithParams(t),u=s.models,l=s.parameters;if(!u||u.length<1)return f.utils.logger(h,"no models to predict"),this.statuses[n]=e.NOT_USED,Promise.resolve({});u.filter(function(e){return e.dfp_targeting}).forEach(function(e){return r.targetedModelNames.add(e.name)});var d=function(e,t){var n=new Date,r=n.getDay()-1;return Object.assign({},{models:e.map(function(e){return e.name}),h:n.getHours(),dow:-1===r?6:r},t)}(u,l);return f.utils.logger(h,"calling service",i,o,d,"callId: ".concat(n)),this.statuses[n]=e.TOO_LATE,x(i,o,d,c,n).catch(function(t){return"timeout"===t.message?r.statuses[n]=e.TIMEOUT:r.statuses[n]=e.FAILURE,Promise.reject(t)}).then(function(e){return function(e){return Object.keys(e).forEach(function(t){var n=f.utils.queryString.get("bill.".concat(t));n&&(e[t].result=parseInt(n,10))}),e}(e)}).then(function(t){var i;f.utils.logger(h,"service response OK","callId: ".concat(n)),r.statuses[n]=e.ON_TIME;var o=r.getModelToResultMap(t);f.utils.logger(h,"predictions",o,"callId: ".concat(n));var c=r.buildPredictions(u,o,n);return(i=r.predictions).push.apply(i,a()(c)),r.setTargeting(),f.events.emit(f.events.BILL_THE_LIZARD_RESPONSE,{callId:n,response:r.serialize(n)}),r.executor.executeMethods(u,t),o}).catch(function(e){return f.utils.logger(h,"service response",e.message,"callId: ".concat(n)),{}})}},{key:"buildPredictions",value:function(e,t,n){return e.map(function(e){return e.name}).filter(function(e){return void 0!==t[e]}).map(function(e){return{modelName:e,callId:n,result:t[e]}})}},{key:"getModelToResultMap",value:function(e){var t={};return Object.keys(e).forEach(function(n){var r=e[n].result;void 0!==r&&(t[n]=r)}),t}},{key:"setTargeting",value:function(){var e=this.getTargeting();if(Object.keys(e).length>0){var t=Object.entries(e).map(function(e){var t=i()(e,2),n=t[0],r=t[1];return"".concat(n,"_").concat(r)});return f.context.set("targeting.btl",t),t}return""}},{key:"getTargeting",value:function(){var e=this,t={};return this.predictions.filter(function(t){return e.targetedModelNames.has(t.modelName)}).forEach(function(e){t[e.modelName]=e.result}),t}},{key:"getPrediction",value:function(e,t){return this.getPredictions(e).find(function(e){return e.callId===t})}},{key:"getPredictions",value:function(e){return e?this.predictions.filter(function(t){return t.modelName.split(":")[0]===e.split(":")[0]}):this.predictions}},{key:"getResponseStatus",value:function(e){return e=e||this.callCounter,this.statuses[e]}},{key:"serialize",value:function(e){var t=this.predictions;return void 0!==e&&(t=t.filter(function(t){return t.callId===e})),t.map(function(e){return"".concat(e.modelName,"|").concat(e.callId,"=").concat(e.result)}).join(",")}},{key:"getPreviousPrediction",value:function(t,n,r){if(!(t<=1))for(var i=t-1;i>=1;i--){var o=n(i),a=this.getResponseStatus(o);if(a===e.ON_TIME||a===e.TOO_LATE)return this.getPrediction(r,o)}}}]),e}();g()(y,"FAILURE","failure"),g()(y,"NOT_USED","not_used"),g()(y,"ON_TIME","on_time"),g()(y,"TIMEOUT","timeout"),g()(y,"TOO_LATE","too_late"),g()(y,"REUSED","reused");var w=new y,b="clarium.global.ssl.fastly.net";var E=new(function(){function e(){s()(this,e)}return l()(e,[{key:"call",value:function(){var e=f.context.get("services.confiant.propertyId"),t=f.context.get("services.confiant.mapping"),n=f.context.get("services.confiant.activation");return f.context.get("services.confiant.enabled")&&e&&t&&n?(f.utils.logger("confiant","loading"),window._clrm=window._clrm||{},window._clrm.gpt={propertyId:e,confiantCdn:b,sandbox:0,mapping:t,activation:n,callback:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];f.utils.logger("confiant",t)}},function(){var e="//".concat(b,"/gpt/a/wrap.js");return f.utils.scriptLoader.loadScript(e,"text/javascript",!0,"first")}().then(function(){f.utils.logger("confiant","ready")})):(f.utils.logger("confiant","disabled"),Promise.resolve())}}]),e}()),k="d3b02estmut877";var _=new(function(){function e(){s()(this,e)}return l()(e,[{key:"call",value:function(){var e=f.context.get("services.geoEdge.id"),t=f.context.get("services.geoEdge.config");return f.context.get("services.geoEdge.enabled")&&e?(f.utils.logger("geo-edge","loading"),window.grumi={cfg:t,key:e},function(){var e="//".concat(k,".cloudfront.net/grumi-ip.js");return f.utils.scriptLoader.loadScript(e,"text/javascript",!0,"first")}().then(function(){f.utils.logger("geo-edge","ready")})):(f.utils.logger("geo-edge","disabled"),Promise.resolve())}}]),e}());function T(e){if(window.localStorage)return window.localStorage[e];if(window.navigator.cookieEnabled){var t=document.cookie.match("".concat(e,"=([^;]*)"));return t&&decodeURI(t[1])||""}return""}window.Krux=window.Krux||function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];window.Krux.q.push(t)},window.Krux.q=window.Krux.q||[];var I=new(function(){function e(){s()(this,e)}return l()(e,[{key:"call",value:function(){var e=this;return f.context.get("services.krux.enabled")&&f.context.get("options.trackingOptIn")?(f.utils.logger("krux","loading"),function(){var e=f.context.get("services.krux.id"),t="//cdn.krxd.net/controltag?confid=".concat(e);return f.utils.scriptLoader.loadScript(t,"text/javascript",!0,"first",{id:"krux-control-tag"})}().then(function(){e.exportPageParams(),e.importUserData()})):(f.utils.logger("krux","disabled"),Promise.resolve())}},{key:"exportPageParams",value:function(){Object.keys(f.context.get("targeting")).forEach(function(e){var t=f.context.get("targeting.".concat(e));t&&(window["kruxDartParam_".concat(e)]=t)})}},{key:"importUserData",value:function(){var e=T("kxuser")||T("kxwikia_user"),t=T("kxsegs")||T("kxwikia_segs");f.context.set("targeting.kuid",e||null),f.context.set("targeting.ksg",t?t.split(","):[]),f.utils.logger("krux","data set",e,t)}},{key:"getUserId",value:function(){return f.context.get("targeting.kuid")||null}},{key:"getSegments",value:function(){return f.context.get("targeting.ksg")||[]}}]),e}());f.events.registerEvent("MOAT_YI_READY");var P=new(function(){function e(){s()(this,e)}return l()(e,[{key:"call",value:function(){var e,t=this;if(!f.context.get("services.moatYi.enabled")||!f.context.get("services.moatYi.partnerCode"))return f.utils.logger("moat-yi","disabled"),Promise.resolve();var n=new Promise(function(t){e=t});return f.utils.logger("moat-yi","loading"),window.moatYieldReady=function(){t.importPageParams(),e()},f.context.set("targeting.m_data","waiting"),function(){var e=f.context.get("services.moatYi.partnerCode"),t="//z.moatads.com/".concat(e,"/yi.js");return f.utils.scriptLoader.loadScript(t,"text/javascript",!0,"first")}().then(function(){f.utils.logger("moat-yi","ready")}),n}},{key:"importPageParams",value:function(){if(window.moatPrebidApi&&"function"==typeof window.moatPrebidApi.getMoatTargetingForPage){var e=window.moatPrebidApi.getMoatTargetingForPage()||{};f.context.set("targeting.m_data",e.m_data),f.events.emit(f.events.MOAT_YI_READY,"m_data=".concat(e.m_data)),f.utils.logger("moat-yi","moatYieldReady",e)}}}]),e}());var O="nielsen-dcr",j={};function L(e){return f.utils.logger(O,"loading"),function(e,t){e[t]=e[t]||{nlsQ:function(n,r,i,o,a,c){return(o=(a=e.document).createElement("script")).async=1,o.src=("http:"===e.location.protocol?"http:":"https:")+"//cdn-gl.imrworldwide.com/conf/"+n+".js#name="+r+"&ns="+t,(c=a.getElementsByTagName("script")[0]).parentNode.insertBefore(o,c),e[t][r]=e[t][r]||{g:i||{},ggPM:function(n,i,o,a,c){(e[t][r].q=e[t][r].q||[]).push([n,i,o,a,c])}},e[t][r]}}}(window,"NOLBUNDLE"),NOLBUNDLE.nlsQ(e,"nlsnInstance",j)}var S=new(function(){function e(){s()(this,e),this.nlsnInstance=null,"1"===f.utils.queryString.get("nielsen-dcr-debug")&&(j.nol_sdkDebug="debug")}return l()(e,[{key:"call",value:function(e){var t=f.context.get("services.nielsen.appId");return f.context.get("services.nielsen.enabled")&&t?(this.nlsnInstance||(this.nlsnInstance=L(t)),f.utils.logger(O,"ready"),this.nlsnInstance.ggPM("staticstart",e),f.utils.logger(O,"called",e),this.nlsnInstance):(f.utils.logger(O,"disabled"),null)}}]),e}());n.d(t,"BillTheLizard",function(){return y}),n.d(t,"billTheLizard",function(){return w}),n.d(t,"confiant",function(){return E}),n.d(t,"geoEdge",function(){return _}),n.d(t,"krux",function(){return I}),n.d(t,"moatYi",function(){return P}),n.d(t,"nielsen",function(){return S})},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}},function(e,t){e.exports=function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}},function(e,t){e.exports=function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}},function(e,t){e.exports=function(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,c=e[Symbol.iterator]();!(r=(a=c.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{r||null==c.return||c.return()}finally{if(i)throw o}}return n}},function(e,t){e.exports=function(e){if(Array.isArray(e))return e}}]);
//# sourceMappingURL=ad-services.global.js.map